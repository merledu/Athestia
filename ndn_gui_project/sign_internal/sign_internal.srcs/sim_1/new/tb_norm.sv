`timescale 1ns / 1ps
import Dilithium_pkg::*;

module compute_infinity_norm_tb;

  // Package parameters (mocked here)
//  localparam int k = 4;         // Example value
//  localparam int q = 8380417;   // Dilithium's q value

  // Clock and reset
  logic clk;
  logic norm_rst;

  // DUT inputs and outputs
  logic signed [31:0] compute_r0_out [0:k-1][0:255];
  logic [31:0] norm_max;
  logic norm_done;

  // Clock generator
  always #0.2 clk = ~clk;

  // Instantiate the DUT
  compute_infinity_norm #(
    .k(8),
    .q(q)
  ) dut (
    .clk(clk),
    .rst(norm_rst),
    .vector(compute_r0_out),
    .max_value(norm_max),
    .done(norm_done)
  );

  // Stimulus
  initial begin
    $display("Starting testbench for compute_infinity_norm");

    // Initialize signals
    clk = 0;
    norm_rst = 1;
    

//    // Zero out the input vector
//    for (int i = 0; i < k; i++)
//      for (int j = 0; j < 256; j++)
//        compute_r0_out[i][j] = 0;

    // Apply some test data
//    compute_r0_out[0][0] = -15;
//    compute_r0_out[0][1] = 100;
//    compute_r0_out[1][200] = -500;
//    compute_r0_out[2][50] = 3000;
//    compute_r0_out[3][128] = -3050; // max absolute value is 3050

    // Deassert reset after a few cycles
    #12;
    norm_rst = 0;
    compute_r0_out <= '{'{161716, 203274, -60268, 104804, -98277, -69667, 210131, 151731, -71006, -138813, -132180, 252120, 10554, 25589, -166589, -134423, -11852, 246879, -24335, -42430, 39775, -171767, 129958, -161620, 68909, -244892, 195223, -151664, -134240, 98134, 177294, -202596, -85778, -179372, -257956, 34642, 174481, 81609, -166964, -73215, 232535, 40900, -260266, 68607, 237501, -155135, 94495, -61059, 42887, 246277, -36668, 199722, 27811, -194680, -138195, -226690, 16252, -169010, -42752, -141132, -226078, 15747, -157936, 96173, -37041, 98612, 173937, 174015, -216800, 16523, -169869, 94413, -931, 155959, 198790, 21699, -17389, -226508, -137605, -221887, 146230, -19847, 198291, -239787, 121855, -175979, 81383, -250168, 26945, 20608, -252116, 184059, 247702, 159995, 118580, -83585, -225157, 77538, -159541, -89710, -104712, -6966, 170160, -15791, 259444, 192504, 6006, 178652, -90629, 72072, -131190, -106382, 227973, -46058, -193012, 24970, -27251, 37692, 172311, 94139, 85760, 40662, -193260, 96843, -115878, -24971, 22736, 224661, -141808, -173136, -253483, -143512, -141975, 128144, 112507, -158608, -135755, -145911, 191915, -40371, 214188, 209581, 209729, -36334, 134374, -13746, -154043, 82985, -3694, 158694, 145345, -28368, -184449, 55647, -116279, -240657, -16988, -50371, -27449, -66569, 258272, -26815, -241388, -242739, 170452, 218270, -127650, 246488, 160721, -6404, 129449, 180346, -33426, -210143, -248879, -33811, -155438, -110119, 250721, -179042, -17851, -61764, 121180, -93145, 164666, 85060, -165480, -253410, -47930, -260859, -96645, 122325, 226202, 66730, 175774, 181059, 17121, -160671, -171812, 239488, -22272, -181188, -106421, 5842, 168850, 17537, 183392, -111142, -252358, -164437, -28536, -147240, -252718, 130994, -38641, 34977, 190080, 248634, 182935, 19314, 59879, -56811, -241336, -86998, 218255, -226611, 25157, -167352, -135200, 97700, -45333, 132203, -173245, 226351, -199013, 81201, 239558, -244613, -147983, -133937, -138718, -86696, 232324, -145998, 226116, 72192, -176066, 235078, -116975, -113158, 238407, -56442, -35378, -105424, -101613, -249985}, '{172044, -100706, 70680, 47965, -212867, -194217, -22184, 195559, -229529, -191411, 151525, 63517, 184018, 242726, -69947, 47273, -93868, 218758, 158645, 89008, -93366, -62320, 151128, -41177, -153350, 131651, 80369, -207454, 39954, -215643, -190587, 10433, -327, -103947, 134593, 152679, 133339, 249525, 60419, -27265, -241627, 132559, -119856, -249217, 82061, -177843, -182311, -12227, -2615, 24939, 198598, 89627, 146112, 13585, -218446, -260458, 140662, 95418, 16121, -94032, 40862, 105363, -7997, 135533, -113754, -250341, 68958, -150616, 4009, 244339, -31580, -160023, 218479, -94639, -120403, -88539, 108495, 83891, -161191, 13562, 130179, 3810, 247364, -197943, -153288, -241923, 110853, 149990, 91552, -95827, -172308, -95211, 150120, -57647, -170877, -226850, 66726, 168451, 142516, 136245, 67396, -104114, 162583, -149738, 13377, -246021, 170051, 155651, -73893, -10070, 215183, 104356, -40408, 124034, 201526, -25926, -162124, 105265, -202887, -102655, -130406, 87008, 224087, 150795, 8, 81798, 191472, -78037, -111882, -152372, 36037, -211220, -56129, 122794, 133351, -121359, -126199, -149892, 234256, -553, 189908, -225232, 199682, -91927, -149258, -98119, -259418, -216929, -245125, -106161, -180596, 46680, -258652, 96250, 77077, -79233, -93892, -140041, 117644, 174868, 64021, 58936, -173724, 213100, 207270, 141472, 13863, -253755, -62995, -47288, -227443, -125203, -204382, 61025, -28835, 11722, 209268, -18232, -193965, -196015, -99542, -146927, -29120, -177472, 49397, 252539, -30351, -217343, 222758, -125578, 206550, -183961, 231912, 137766, -18682, 96500, 160841, 173280, -117787, 55548, -23723, 70036, 168570, 13039, 88860, 1431, 248289, 105509, 152640, 118124, -123354, 111217, 249732, 82773, 140649, -63880, 40667, 119507, -221747, 86959, -114321, -219150, 204829, -211291, -110536, 31039, 173867, 73729, -251316, 88031, 250422, 144906, 80544, -186166, 243535, 47139, 95138, 63003, -144685, 163068, -20848, 164737, -84554, 253357, -225543, -86943, -89111, 63569, 190886, -142342, -135333, -121818, 191604, -225961, -205567, -193032}, '{150708, 198319, 163146, -79329, -28216, -20542, 1111, -83373, -163366, -106919, 44231, 140408, 224910, 221030, 118156, -100105, 154147, -238835, -103243, -11623, 23480, -9003, 41403, -53259, 174785, 201382, 226952, -208065, 88650, -162094, -122284, 184195, -230999, 27604, 76203, 89954, 209095, 173288, -181219, 134791, -235631, -73071, -167037, -156067, 150254, 83331, 116193, -15660, 136425, 67466, -14002, -188408, 219059, 243587, 155776, -69305, -171174, -45618, 229400, -214974, 235655, -184826, 261466, -67043, -6147, -235641, 176097, -123363, 261185, -86116, -87778, -250570, -213516, 171084, 249647, -48379, 35901, 153630, 10, -187517, -107728, -156983, -245579, 208013, -237548, -44142, 22807, -41565, 73142, -131657, 103552, -19476, 52233, 7735, -246012, 71, 94707, -93442, 104694, -166367, 228072, -98398, 153939, 245428, 72234, -115271, 237485, -10848, -210183, -131444, -57638, -240779, -85274, -80565, -220284, -166231, -244232, -131788, 244346, -14231, -8641, 224506, 115278, -91470, -89836, 93428, -196579, 90946, -165001, -192628, -21615, 173024, 253238, -236616, -2548, -100646, 252393, 216943, -107040, -145957, 27689, -177636, 3174, -131366, -169457, -4457, -200947, 51000, 107153, 177208, -56002, -178226, 181117, -171621, -254552, -118651, -86163, 4744, -256469, -194016, -78293, 58997, 93916, 17692, 115775, 45696, -123329, 230469, -74345, -35277, 42727, 32831, 127996, -177505, 133811, 187488, -218816, -200147, 152304, 252724, -175112, 172793, -43510, 6852, -21379, 15165, -190531, -187299, 34475, 76636, 1519, -210566, -156664, -126036, -145544, -131785, 21045, -79105, -91591, -27072, 109330, 39644, 151367, 181571, -231276, -233591, 187075, 87156, -195104, -99111, -258806, 83807, 157897, -257736, 63687, -54278, -106424, 90680, -26031, 251854, -160552, -12046, 40043, -251706, 187281, -172678, -111016, 198975, -52300, -48380, -232167, 77379, -104852, 80403, 119225, -49848, -215258, 82795, -243034, -219029, 81900, -90183, 250081, 214017, -73564, -111288, 118611, -64125, -116935, -199387, 156258, -27451, 240759, 63526, 135819, -189574}, '{199739, -130051, 175287, -154780, 203892, -252942, 119738, 60797, 68399, -130601, 3993, 28029, 250020, -183336, 97826, -15879, -103223, -98622, 83928, -219655, -112579, 45800, -111560, -159655, -123959, -171728, 184047, 55077, -219310, 237633, 25591, -132959, -8443, 8724, 97051, -6399, -112628, 242014, -212214, -148430, -166715, 83084, 182885, 105724, 229790, -35334, -53654, 4613, 15007, 52509, -250382, -143005, -153929, 75815, -248722, -53333, -206216, -206647, -201267, 251296, -155594, 119516, -157688, 137565, -4000, 49315, 214741, 148914, 17615, -158066, 260639, -205076, 81459, -37021, -96360, -186620, 108941, -48208, 11855, 147765, -177648, -162944, -78801, -57512, -179384, 174658, 192047, 131251, 201128, 157122, -83662, 248725, 176567, 145845, -198546, -206148, -23260, 16540, 180187, -207944, 104144, 14315, 177558, -132676, 107641, -35142, -224713, -97791, -260739, 229707, -31545, 144123, -134443, -205016, 2997, -12509, -69462, 160, -60173, -102328, -147496, -240622, 214081, 127130, -69882, -14686, -55350, 101020, -13088, 174322, 153472, -227863, -17445, -251414, -107431, 117598, -32213, -121699, 185631, -48836, -84963, 231372, 252282, 254701, 94375, 200923, 25855, 50595, 28602, -235411, 104651, -57386, 30677, -218509, -22006, -253036, -69585, -44308, 226036, 255105, 199668, -146002, -60053, 81540, 136084, -216321, 210136, 50558, -59368, 225670, 239485, -101388, -204480, 202182, -143938, -245798, -198269, 233937, 150846, -9609, 255747, 255563, 25394, 79330, 44490, 1625, 198531, 47628, 60153, 236718, -63181, 198600, 149340, -68688, -191585, -106968, -77255, 133650, -227139, -111690, 129249, 131149, -176980, 90047, 211832, 120344, -38535, -79028, 112489, 6240, 159875, 116114, -108448, -148062, -131243, 68277, 136512, 256510, -49218, -106097, -57906, 15541, -17040, -202060, -22097, -58378, -180956, 169964, 228714, 100248, 213496, 244747, -113058, 255480, -38729, 174338, 126559, 203695, 156767, -241432, 58104, 45721, 214242, 257194, 204104, 214488, -217216, 37041, 192478, 223112, 191659, -245952, -86211, 227419, -86955, 38484}, '{107546, 38147, 48022, -199293, 229905, -119125, 54188, -66095, -93739, -145747, 256916, 191510, -65837, 247843, -255637, -87626, 116262, 186532, -104717, 235738, -135077, 118005, -132867, -241302, -226640, 55878, -236581, -65560, 221266, -49345, 125769, 18913, 62783, -46634, 3630, -151351, -100064, 31800, 24981, 148810, -13068, 232121, -132091, 245413, 216500, 145836, -232982, -163000, 60839, -96963, 5700, 230462, 87355, 180086, 7837, -154677, -90901, 14211, -125200, -112232, 40631, -105536, -193519, 27293, 164520, -222446, -209699, -191918, -151900, 235924, -77504, 50200, 259966, -226641, -245601, -211547, -109755, 57368, -24715, 97727, 72760, -91918, 205558, 12536, 240284, 12809, 183518, -2082, -212849, -130436, 182873, 56348, -198709, 67848, 252065, 200557, -103072, 79127, 241492, -204691, -62820, -179071, 80009, 26633, 42949, -78412, 233119, 189185, 30401, 44014, -156935, -82601, 152865, -39429, 64820, -187216, 74494, -32196, -29924, -195529, -113857, 52116, 139947, 232248, -195260, -112546, -173782, 128953, -4532, -6815, 190887, 208772, 223463, 230971, 79580, -172099, -174144, -124705, -85274, 30641, -183994, 239347, 86864, -17625, -172213, -162982, -168508, 100606, 210515, -46072, 35350, -113054, -45600, 105789, -171142, 19464, 147655, -238558, 167155, 200766, 161824, -203448, 204504, -48664, -71688, -60704, 46388, -9651, -38077, 232134, 164512, -166708, 81640, -232275, -197204, -241326, 92991, 198044, -86588, -56974, 105844, -164738, -23211, 247267, -149678, 126421, -116904, 55779, -179943, -87532, -198489, 65286, -227568, -117928, -2017, 236624, -70267, -191859, -230380, 107914, -78325, -193459, 175680, 17087, 25280, -16038, 172563, -157713, 65401, -102090, -38168, 47301, 202026, -176898, 195040, -55923, 208844, -87501, 217608, 181114, 5357, 167382, 33963, 161261, -242700, -106108, -4034, -25886, 73747, -216043, 123221, 187406, 162490, 199451, -244981, 134809, 119276, 194963, 4207, -79184, -242482, -88918, -118550, 108415, -225788, 73456, 25182, 87954, 11126, 246336, -111819, -158918, -246537, 220350, 16500, 152049}, '{221490, -123666, 67845, -258273, 169493, -74215, 100733, 154438, -64303, 230787, 28387, -219207, 231688, 43896, 34199, -110989, -186207, -43643, 178198, 203397, 100773, 195144, 47599, 73495, 3974, -123495, -4457, -102954, 9962, -41466, -157677, -73397, -95976, 212654, -157380, 229961, -24618, 227664, -149081, -114203, 62972, -211975, 50346, -219875, 199267, -53368, 211451, 191415, 144065, -101991, 65645, 2400, -83698, -134405, 215937, -64226, -54067, 197521, 163188, 9335, -115604, -70935, 127348, 229572, 254301, 39124, 242560, 194942, 83816, -257306, -65668, -182585, -131132, -42773, 37621, 103207, 237532, -230495, 51633, -113248, -61139, -41466, -138947, -189194, -179002, 154941, -138703, 168055, 48938, -67828, -189520, 248507, 135087, 125093, -173124, 60960, -61532, 110334, -75958, 199281, -93113, -188726, 190634, 211948, 109564, -47208, 78751, -16345, 52019, 117484, 208394, -121317, 43275, 69115, 116094, 88540, -60742, 202526, 207776, 133624, 70133, 232446, -216950, -219740, -12666, -41404, -159802, 105169, 13716, -238913, 111739, -246825, -98145, -160495, -249030, -14220, 261451, -84497, -222355, -92347, -195360, 251325, -180047, 138879, 136243, -124672, 10224, 198239, 57201, 225109, -119572, 213645, 149032, 76341, -191657, -102480, -1747, -140803, -12585, -52455, 253256, 115343, -218981, 202531, -197755, -199575, 93305, -91879, -89250, 24251, -148922, 69172, -221856, 158199, 15066, 69206, -59801, -69886, -55508, -112633, -246377, -247255, 204145, 104411, 170437, -142679, 14139, 248664, 236492, 212864, 245662, 5410, -177605, 65721, -182432, 150710, -49180, -55383, -241037, -150554, -236647, 73251, 124244, 16453, 171414, -219341, -127902, -245494, -183003, 193007, 75032, -39646, 118292, 123878, -170104, -222438, -120556, 11202, -15955, -170698, -195053, 68935, 224035, 131873, -56001, -82675, -206729, 181223, 11945, -221130, 76920, -118174, 92199, -182056, 229034, 104767, 34060, -190083, 98404, 188790, 207605, 234755, -254556, -187163, -75348, 138108, -163659, -81742, 78941, 226743, 65522, -58572, -215701, -86474, 171567, -51615}, '{-109579, 108746, -58087, 121847, 24267, 203642, -44423, -193133, 8440, -215846, -98467, 87784, 11082, 64882, 196889, 25239, -258838, -97258, 171638, -118235, 228323, 216171, 230145, 56762, -100549, 253705, 136036, 95928, 261783, 223801, 57600, -212890, -157599, 42954, 179172, -236128, 239086, 152959, -197712, 149566, 165350, -20802, -107602, 147150, 230268, 47501, 97361, -109280, -2693, -203139, 202587, 93245, -208658, -151693, 237991, -193103, 145012, -6442, -217851, 170712, -28561, 210403, -115078, -54075, -247064, -129840, -57277, -61148, 156835, 3634, -251080, -106246, 23213, -189138, 169304, 97769, 70565, -4622, 105328, -31000, 137429, 137467, -184914, 261543, -30272, -219217, -164927, -186689, 261377, -173420, 192810, -90634, -188344, 249164, -231160, -21034, -145233, 52139, -60867, -8270, 25426, 9896, 240818, -134281, -110161, -65934, 41242, -10995, 161568, 33877, -157730, 14365, -144850, 23448, 83229, 210635, 107394, -230480, -74701, 120955, 229308, 82331, 155295, 214729, 22113, 105145, 64697, -171674, 88270, 257347, -234410, -68762, 7653, -51352, 69448, 10378, 131043, 212250, 12171, -55323, -158429, 1439, -238679, -43089, 66212, -185636, -109226, 165669, -112370, -251790, 27163, 26635, 146588, -113539, -200934, -1591, 4366, -51263, 43154, 111443, 134475, 28703, -154189, 64609, -24456, -30530, 7741, 35219, -144798, 212532, 63836, 139997, 116736, 198990, -99150, 161576, 107660, -77499, 27074, 174759, 109342, -174821, -107123, -48533, 98551, -39205, 211739, 256433, -46915, 238808, -110171, -210120, -227148, 202427, 257920, -113509, -186830, -187724, -23873, 88419, 105098, -224679, -146834, -126297, 248456, -2139, -92874, 10614, 61101, 245288, 66736, -111533, 67702, -61159, 119837, -218288, 208866, -140445, -103369, 86904, 92806, 168090, 34159, -85022, -77149, -236464, 229223, -200638, -99879, -247099, -61925, 206273, -213124, -199795, -92553, -181931, -154076, -8589, 150125, -13931, 170258, 102979, -220566, 213881, 251723, -136018, 120784, 78640, 73111, 5722, -165008, -196490, -30068, 63373, -197471, 149594}, '{-22006, -159176, -44879, 197519, -243338, -116948, -70888, -179509, 19276, 234704, -204696, -211943, -44745, -82037, -235752, -63003, 82484, -68288, 49569, 208529, 93344, -250932, 134909, 201363, 229846, -161862, -98730, -89404, 150469, 103048, -125378, 207206, -207796, -84981, 232378, 248743, 234520, 199906, -129020, -259036, -40952, -74477, 8474, -102277, -108763, 202091, 234458, -178140, -250874, 251307, -67366, -49579, -20046, -73967, 49926, 118098, -68966, -249527, 180088, 102604, 181849, -25913, 110269, 176957, 171917, -173488, -29539, 176479, 84466, -115452, 52849, 129000, 237925, 17039, -182427, -29469, 14819, 132530, -41947, 196571, 49314, -1987, 136451, -1731, 37320, 30844, 117495, 36630, -258550, -74203, 208692, -105199, 234545, -258686, 217638, -39819, 175318, -77933, -13528, 195051, -249198, -35395, 246715, -65103, 2886, 251887, 55169, 91897, -22163, -116255, -45264, 222680, 107919, 93567, 18107, -192551, -102053, -238442, -42504, 166802, -182173, -216974, 112265, -207361, -161402, -175454, 208556, 189504, 92189, 135529, -101060, -83418, 73168, 20604, -222076, -33479, -100351, 63739, 109133, -30402, -151786, -120415, 253226, 44121, -117720, -3577, -6018, -122812, 190915, -2077, 161654, 202028, -6221, 12593, -226624, 235192, 182681, 195187, 158738, 133430, -3528, 85375, -146589, -250124, 234302, -106031, -196690, -84832, -211743, -59346, -257932, 84328, -65534, 66592, -260876, -11768, 5214, 142499, 150127, 49813, 2299, 247028, -220747, -257394, 74902, -183995, 129825, 94994, -47343, 248695, -187323, 133232, 113421, -258293, 1307, -99449, -166754, -144589, -121576, 6776, -261194, 184111, 59553, -199186, 132472, 127857, 197903, 38114, 187865, -4332, -216016, 54743, 205474, 135945, -74080, -19172, -116849, 63819, -129728, -221750, -13973, 75999, 168235, 13144, 202695, 48737, -180389, -171877, -211788, 77029, -58864, 92666, -122179, -83419, -251923, 170154, -56545, -160572, -159680, 144000, -128871, 183479, 207040, -119486, 92486, 237709, -230327, -128846, -247455, 116423, -101992, 112745, -239592, 195430, 89056, 47334}};

    // Wait for done signal
    wait (norm_done == 1);
    #1000;

    // Display result
    $display("Max infinity norm value: %0d", norm_max);

    // Finish
    $finish;
  end

endmodule
